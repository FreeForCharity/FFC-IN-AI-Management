# PowerShell Infrastructure Overlay for CLAUDE.md

> Append this content to the base CLAUDE.md when deploying to PowerShell/infrastructure repos
> such as FFC-Cloudflare-Automation.

---

## PowerShell Infrastructure Context

This repository is a PowerShell-based infrastructure automation toolset. It manages DNS,
email authentication, domain billing, and website provisioning for ~30 charity domains
across the Free For Charity network.

### PowerShell Conventions

- **Formatting**: All `.ps1` files must pass `Invoke-Formatter` (from PSScriptAnalyzer). The CI
  pipeline compares original vs. formatted output and fails on any difference. Run locally before
  committing:
  ```powershell
  Import-Module PSScriptAnalyzer
  $original = Get-Content -Path .\MyScript.ps1 -Raw
  $formatted = Invoke-Formatter -ScriptDefinition $original
  Set-Content -Path .\MyScript.ps1 -Value $formatted -NoNewline
  ```
- **Linting**: PSScriptAnalyzer runs in CI with `-Severity @('Error','Warning')`. Errors fail the
  build; warnings are reported but tolerated.
- **Approved verbs**: Use standard PowerShell verbs: `Get-`, `Set-`, `New-`, `Remove-`, `Update-`,
  `Export-`, `Import-`, `Invoke-`, `Test-`.
- **Parameters**: Follow existing patterns -- `[Parameter(Mandatory = $true)]` with
  `[ValidateNotNullOrEmpty()]` or `[ValidateSet()]` as appropriate.
- **Destructive operations**: Support `-DryRun` or `-WhatIf` switches. Preview changes and print
  what would happen without applying them.
- **Error handling**: Use `try/catch` blocks. Call `Write-Error` for failures. Use `exit 1` for
  fatal errors that should stop the pipeline.
- **API token validation**: Always check that the required API token environment variable is
  present before making any API call. Fail early with a clear message if missing.

### GitHub Actions Workflows

This repo has 24+ GitHub Actions workflows using a numbered naming convention for UI ordering:

| Prefix | Category | Examples |
|--------|----------|---------|
| 0-* | Status/reporting | `0-domain-status.yml` |
| 1-* | Standards enforcement | `1-enforce-domain-standard.yml`, `1-audit-compliance.yml` |
| 2-* | Enforcement | `2-enforce-standard.yml` |
| 3-* | DNS record management | `3-manage-record.yml` |
| 4-* | Export/inventory | `4-domain-export-inventory.yml`, `4-export-summary.yml` |
| 5-8 | M365 operations | `5-m365-domain-and-dkim.yml`, `6-m365-list-domains.yml` |
| 7-8 | WHMCS operations | `7-whmcs-export-domains.yml`, `8-whmcs-export-products.yml` |
| 9-10 | WHMCS billing | `9-whmcs-export-payment-methods.yml`, `10-whmcs-zeffy-payments-import-draft.yml` |
| 11-15 | Provisioning | `11-cloudflare-zone-create.yml`, `15-website-provision.yml` |

Workflow names in YAML must start with a two-digit prefix (e.g., `name: '05. M365 - DKIM Setup'`).
The CI pipeline validates that prefixes are present and unique.

### CI Pipeline Checks

The `ci.yml` workflow runs on every PR and push to main:

1. **Workflow name prefix validation** -- two-digit prefixes, unique across all workflows
2. **actionlint** -- validates all workflow YAML syntax and expressions
3. **Prettier** -- checks formatting of YAML, JSON, Markdown files
4. **PowerShell syntax validation** -- parses all `.ps1` files for syntax errors
5. **PSScriptAnalyzer** -- lints PowerShell for errors and warnings
6. **Invoke-Formatter** -- checks PowerShell formatting matches expected output
7. **Sensitive file detection** -- scans for `.pem`, `.key`, `.env`, `.env.local` files

### Cloudflare Integration

- **Dual-account support**: FFC account and CM (Clarke Moyer) account, each with separate API tokens
- Environment variables: `CLOUDFLARE_API_TOKEN_FFC` and `CLOUDFLARE_API_TOKEN_CM`
- GitHub Secrets: `FFC_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS` and `CM_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS`
- Scripts auto-detect which token can access a given zone
- Operations: zone creation, DNS record CRUD, DNS export, domain status reporting

### M365 Integration

- **Graph API via OIDC**: Federated credentials, no stored client secrets
- Domain operations: add domain to tenant, verify ownership via TXT record
- Email authentication: DKIM enable, SPF/DKIM/DMARC record creation in Cloudflare
- Standard MX record: `0 <domain>.mail.protection.outlook.com`
- Standard SPF: `v=spf1 include:spf.protection.outlook.com -all`
- DKIM: Two CNAME selectors pointing to `*.domainkey.<domain>.onmicrosoft.com`
- DMARC: `v=DMARC1; p=reject; rua=mailto:dmarc@<domain>`

### WHMCS Integration

- Domain billing exports and lookups
- Nameserver management (set Cloudflare NS on registered domains)
- Client, invoice, and transaction reporting
- Payment method exports

### WPMUDEV Integration

- WordPress hosting site inventory exports
- Site health monitoring data

### GitHub Environment Secrets

Workflows that need secrets must use GitHub Environments:

| Environment | Secrets Available |
|-------------|------------------|
| `cloudflare-prod` | `FFC_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS`, `CM_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS` |
| `m365-prod` | Azure AD OIDC credentials for Graph API |
| `github-prod` | `GH_PAT` for cross-repo operations |
| `wpmudev-prod` | `WPMUDEV_API_KEY` |
| `whmcs-prod` | `WHMCS_API_IDENTIFIER`, `WHMCS_API_SECRET`, `WHMCS_API_URL` |
